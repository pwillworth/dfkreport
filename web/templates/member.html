<html lang="en">
<head>
  <title>Members Page</title>
  <meta property="og:title" content="Lila's Ledger Member Page">
  <meta property="og:description" content="Defi Kingdoms Transaction History reporting to help quantify potential taxable events.">
  <meta property="og:image" content="{{ BASE_SCRIPT_URL }}static/images/favicon.png">
  <link rel="stylesheet" type="text/css" href="/static/dfktax.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/static/jquery-ui.min.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/static/jquery-ui.structure.min.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/static/jquery-ui.theme.min.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/static/dfktax.css" media="screen" />
  <script src="/static/dfktax.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4-rc.1/web3.min.js"></script>
</head>
<body>
<script>
window.onload = (event) => {
  sid = getCookie('sid', '');
  isConnected()
  window.web3 = new Web3(window.ethereum);
  setTimeout('refreshLists', 120000);
  switchView('{{ memberState }}');
  // keep the footer at the bottom
  if (window.innerHeight > 200) {
    document.getElementById('accountDetails').style.height = window.innerHeight - 130;
  }
};
window.ethereum.on('accountsChanged', function (accounts) {
  console.log(`wallet changed to ${accounts[0]}!`);
  resetConnection();
  handleAccountsChanged(accounts);
});
function switchView(memberState) {
  //0=not loggged in, 1=inactive, 2=active
  switch (memberState) {
    case '2':
      document.getElementById('groupPage').style.display = 'block';
      document.getElementById('reportPage').style.display = 'block';
      document.getElementById('subscribePage').style.display = 'none';
      document.getElementById('connectPage').style.display = 'none';
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('benefitsPage').style.display = 'none';
      document.getElementById('benefitsHeader').style.display = 'none';
      break;
    case '1':
      document.getElementById('groupPage').style.display = 'none';
      document.getElementById('reportPage').style.display = 'none';
      document.getElementById('subscribePage').style.display = 'block';
      document.getElementById('connectPage').style.display = 'none';
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('benefitsPage').style.display = 'block';
      document.getElementById('benefitsHeader').style.display = 'block';
      break;
    case '0':
      document.getElementById('groupPage').style.display = 'none';
      document.getElementById('reportPage').style.display = 'none';
      document.getElementById('subscribePage').style.display = 'none';
      if (isConnected()) {
        document.getElementById('connectPage').style.display = 'none';
        document.getElementById('loginPage').style.display = 'block';
      } else {
        document.getElementById('connectPage').style.display = 'block';
        document.getElementById('loginPage').style.display = 'none';
      }
      document.getElementById('benefitsPage').style.display = 'block';
      document.getElementById('benefitsHeader').style.display = 'block';
      break;
    default:
      //nada
  }
}
function refreshLists() {
  loadGroups();
  loadReports();
}
function loadReports() {
  if (!isConnected()) {
    alert('you need to connect a wallet first!');
    return;
  }
  const wAddress = selectedAccount;
  var request = new XMLHttpRequest();
  request.open('GET', `{{ BASE_SCRIPT_URL }}getReportList.py?account=${wAddress}&sid=${sid}`, true);
  console.log(`loading: {{ BASE_SCRIPT_URL }}getReportList.py?account=${wAddress}&sid=sid${sid}`);
  request.onload = function() {
    console.log('load completed');
    if (!request.status || (request.status >= 400)) {
      alert('Failed to load reports.');
    } else {
      var resp = JSON.parse(request.responseText);
      if ('error' in resp) {
        document.getElementById('reportList').innerHTML = resp['error'];
      } else {
        reportTable(resp);
        console.log('loaded');
      }
    }
  };
  request.send();
  //setTimeout('loadReports()', 2000);
}
function loadGroups() {
  if (!isConnected()) {
    alert('you need to connect a wallet first!');
    return;
  }
  const wAddress = selectedAccount;
  var request = new XMLHttpRequest();
  request.open('GET', `{{ BASE_SCRIPT_URL }}getGroupList.py?account=${wAddress}&sid=${sid}`, true);
  console.log(`loading: {{ BASE_SCRIPT_URL }}getGroupList.py?account=${wAddress}&sid=${sid}`);
  request.onload = function() {
    if (!request.status || (request.status >= 400)) {
      alert('Failed to load wallet groups.');
    } else {
      var resp = JSON.parse(request.responseText);
      if ('error' in resp) {
        document.getElementById('groupList').innerHTML = resp['error'];
      } else {
        groupTable(resp);
        console.log('loaded');
      }
    }
  };
  request.send();
}
function viewReport(contentFile) {
  window.open(`{{ BASE_SCRIPT_URL }}/report.py?contentFile=${contentFile}`);
}
function reportTable(data) {
  const reportStatus = ['Created','Processing','Complete'];
  var listElm = document.getElementById('reportList');
  var newRow = document.createElement('tr');
  listElm.innerHTML = '';
  newRow.innerHTML = '<th>Wallet</th><th>Date Range</th><th>Status</th><th>Transactions</th><th>Percent Complete</th><th>View</th>';
  listElm.appendChild(newRow);
  data['reports'].forEach((report) => {
    if ( report[0].substring(0, 2) == '0x' ) {
      var addr = report[0].substring(0, 6) + '...' + report[0].substring(38, 42);
    } else {
      var addr = report[0];
    }
    var status = reportStatus[report[4]];
    var percentFetched = report[6]/report[5]*100;
    var percentComplete = report[7]/report[5]*100;
    var newRow = document.createElement('tr');
    var actionColumn = '';
    if (status == 'Complete') {
      actionColumn = `<input type="button" value="View" onclick="viewReport('${report[8]}');" class="lButton" />`;
    }
    newRow.innerHTML = `<td>${addr}</td><td>${report[1]} - ${report[2]}</td><td>${status}</td><td>${report[5]}</td><td>${percentComplete.toFixed(0)}%</td><td>${actionColumn}</td>`;
    listElm.appendChild(newRow);
  });
}
function groupTable(data) {
  var listElm = document.getElementById('groupList');
  var newRow = document.createElement('tr');
  listElm.innerHTML = '';
  newRow.innerHTML = '<th>Group Name</th><th>Wallets</th><th>Remove</th>';
  listElm.appendChild(newRow);
  data['groups'].forEach((report) => {
    var gName = report[1];
    var gWallets = JSON.parse(report[2]);
    var walletList = '';
    for (let i=0; i < gWallets.length; i++) {
      walletList = walletList + gWallets[i] + ','
    }
    var newRow = document.createElement('tr');
    newRow.innerHTML = `<td>${gName}</td><td>${walletList}</td><td><input type="button" value="Delete" onclick="removeGroup(event, '${gName}');" class="lButton" />`;
    newRow.addEventListener('click', function() {
      editGroup(report[1], gWallets);
    });
    newRow.style.cursor = 'pointer';
    listElm.appendChild(newRow);
  });
}
function createGroup(groupName, walletList) {
  if (!isConnected()) {
    alert('you need to connect a wallet first!');
    return;
  }
  const account = web3.eth.accounts;
  const wAddress = account.givenProvider.selectedAddress;
  var request = new XMLHttpRequest();
  var wallets = encodeURIComponent(walletList);
  request.open('POST', `{{ BASE_SCRIPT_URL }}postGroupList.py?account=${wAddress}&sid=${sid}&groupName=${groupName}&wallets=${wallets}`, true);
  console.log(`loading: {{ BASE_SCRIPT_URL }}postGroupList.py?account=${wAddress}&sid=${sid}&groupName=${groupName}&wallets=${wallets}`);
  request.onload = function() {
    if (!request.status || (request.status >= 400)) {
      alert('Failed to add wallet group due to server error.');
    } else {
      var resp = JSON.parse(request.responseText);
      if ('error' in resp) {
        alert(resp['error']);
      } else {
        hideWindow('groupDialog');
        loadGroups();
      }
    }
  };
  request.send();
}
function removeGroup(event, groupName) {
  event.stopPropagation();
  if (!isConnected()) {
    alert('you need to connect a wallet first!');
    return;
  }
  const account = web3.eth.accounts;
  const wAddress = account.givenProvider.selectedAddress;
  var request = new XMLHttpRequest();
  var wallets = encodeURIComponent(walletList);
  request.open('POST', `{{ BASE_SCRIPT_URL }}removeGroupList.py?account=${wAddress}&sid=${sid}&groupName=${groupName}`, true);
  console.log(`loading: {{ BASE_SCRIPT_URL }}removeGroupList.py?account=${wAddress}&sid=${sid}&groupName=${groupName}`);
  request.onload = function() {
    if (!request.status || (request.status >= 400)) {
      alert('Failed to remove wallet group due to server error.');
    } else {
      var resp = JSON.parse(request.responseText);
      if ('error' in resp) {
        alert(resp['error']);
      } else {
        loadGroups();
      }
    }
  };
  request.send();
}
function addGroup() {
  document.getElementById('walletList').value = selectedAccount;
  document.getElementById('groupName').value = '';
  document.getElementById('createGroup').value = 'Create';
  showWindow('groupDialog');
}
function editGroup(currentName, currentList) {
  document.getElementById('walletList').value = currentList;
  document.getElementById('groupName').value = currentName;
  document.getElementById('createGroup').value = 'Update';
  showWindow('groupDialog');
}
// preview balance of selected token
async function updateBalanceInfo() {
  var tokenElm = document.getElementById('tokenSelect');
  var availableElm = document.getElementById('tokenAvailable');
  availableElm.innerHTML = '-';
  token = tokenElm.value;
  if (token == '0xCCb93dABD71c8Dad03Fc4CE5559dC3D89F67a260') {
    let result = await web3.eth.getBalance(selectedAccount);
    availableElm.innerHTML = Number(web3.utils.fromWei(result.toString(), 'ether')).toFixed(2);
  } else {
    const contract = new web3.eth.Contract(balanceOfABI, token)
    let result = await contract.methods.balanceOf(selectedAccount).call();
    availableElm.innerHTML = Number(web3.utils.fromWei(result.toString(), 'ether')).toFixed(2);
  }
}
// preview amount of time that will be added to subscription
function calcTimeToAdd() {
  var timeElm = document.getElementById('subTimeToAdd');
  var tokenElm = document.getElementById('tokenSelect');
  var amountElm = document.getElementById('tokenAmount');
  var usdValue = getUSD(tokenElm.value);
  var totalValue = amountElm.value * usdValue;
  var secondsToAdd = totalValue * 86400 * 4;
  timeElm.innerHTML = timeDescription(secondsToAdd);
}
function getUSD(token) {
  const valsUSD = {
    '0x3AD9DFE640E1A9Cc1D9B0948620820D975c3803a': 1.00,
    '0xCCb93dABD71c8Dad03Fc4CE5559dC3D89F67a260': 0.50,
    '0x04b9dA42306B023f3572e106B11D82aAd9D32EBb': 0.10
  }
  return valsUSD[token];
}
function timeDescription(seconds) {
  if (seconds > 0) {
		tmpDays = Math.floor(seconds / 86400)
		tmpStr = ''
		if (tmpDays > 0) {
			if (tmpDays > 365) {
				tmpStr = Math.floor(tmpDays / 365).toString() + " years, "
				tmpDays = tmpDays % 365
      }
			tmpStr = tmpStr + tmpDays.toString() + " days"
    } else if (seconds / 3600 >= 1) {
			tmpStr = Math.floor(seconds/3600).toString() + " hours"
    } else if (seconds / 60 >= 1) {
			tmpStr = Math.floor(seconds/60).toString() + " minutes"
    } else {
			tmpStr = "less than a minute"
    }
		return tmpStr
  } else {
    return '-';
  }
}
// Initiate payment tx for subscription8
async function paySubscription() {
  const donationAccount = '0x15Ca8d8d7048F694980C717369C55b53e4FbCAEe';
  var tokenElm = document.getElementById('tokenSelect');
  var amountElm = document.getElementById('tokenAmount');
  var sendElm = document.getElementById('tokenSend');
  let txValue = '0x00';
  let data = '0x00';
  sendElm.attributes.disabled = 'disabled';
  if ( tokenElm.value == '0xCCb93dABD71c8Dad03Fc4CE5559dC3D89F67a260') {
    txValue = web3.utils.toWei(amountElm.value);
    //console.log('set value');
  } else {
    let contract = new web3.eth.Contract(transferABI, tokenElm.value, { from: selectedAccount });
    let amount = web3.utils.toHex(web3.utils.toWei(amountElm.value));
    data = contract.methods.transfer(donationAccount, amount).encodeABI();
    //console.log('set data');
  }
  var transactionParameters = {
    nonce: '0x00', // ignored by MetaMask
    gasPrice: '0x09184e72a000', // customizable by user during MetaMask confirmation.
    gas: '0x2710', // customizable by user during MetaMask confirmation.
    to: donationAccount, // Required except during contract publications.
    from: ethereum.selectedAddress, // must match user's active address.
    value: txValue, // Only required to send ether to the recipient from the initiating external account.
    data: data, // Optional, but used for defining smart contract creation and interaction.
    chainId: '0x3', // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.
  };
  //console.log(transactionParameters);
  var statusElm = document.getElementById('paymentStatus');
  statusElm.innerHTML = 'Transaction Pending...';
  statusElm.style.display = 'block';
  // txHash is a hex string
  // As with any RPC call, it may throw an error
  var txHash = await ethereum.request({
    method: 'eth_sendTransaction',
    params: [transactionParameters],
  });
}
function paymentComplete(e) {
  var statusElm = document.getElementById('paymentStatus');
  statusElm.innerHTML = 'Updating account...';
  txHash = e.txHash;
  // add payments db record
  // update members record expires time
  // reload page
}
</script>
<div style="height: 100px;">
  <h1><span id="dfkrptTitle">DeFi Kingdoms: Lila's Ledger</span>
    <div style="float:right;" id="loginBlock"><input id="connectWallet" type="button" value="Connect Wallet" onclick="connect();" class="lButton"><span id="member"></span><input id="loginButton" type="button" value="Login" onclick="login(true);" class="lButton" style="display:none;"><input id="logoutButton" type="button" value="Logout" onclick="logout();" class="lButton" style="display:none;"></div>
  </h1>
</div>
<div id="mainContent" class="wrapper">
  <div id="leftNavContent" class="ghCol">
    <div id="accountDetails" class="ghWidgetBox ui-widget-content">
    {% if memberState > 0 %}
      <div class="sectionHead"></div>
      <h3>Your Account:</h3>
      {% if secondsLeft < 0 %}
      <div id="accountExpiration">Subscription Expired: <span style="font-weight:bold;">{{ expiryDescription }}</span></div>
      {% elif secondsLeft > 0 %}
      <div id="accountExpiration">Subscription Expires: <span style="font-weight:bold;">{{ expiryDescription }}</span></div>
      {% else %}
      <div id="accountExpiration">Not Subscribed</div>
      {% endif %}
      <div class="sectionHead"></div>
      <h4 style="margin-top:24px;">Add time to your subscription:</h4>
      <form>
        <table id="paymentTable">
          <tr><td><select id="tokenSelect" onchange="updateBalanceInfo();calcTimeToAdd();"><option value="0">Select token...</option><option value="0x3AD9DFE640E1A9Cc1D9B0948620820D975c3803a">USDC</option><option value="0xCCb93dABD71c8Dad03Fc4CE5559dC3D89F67a260">Jewel</option><option value="0x04b9dA42306B023f3572e106B11D82aAd9D32EBb">Crystal</option></select></td><td><span id="tokenAvailable" style="color:green;">-</span><span> Available</span></td></tr>
          <tr><td><h4>Amount:</h4></td><td><input type="text" id="tokenAmount" size="10" onkeyup="calcTimeToAdd();" /></td></tr>
          <tr><td><h4>Time to be Added:</h4></td><td><span id="subTimeToAdd"></span></td></tr>
          <tr><td colspan="2" style="text-align:center;"><input id="tokenSend" type="button" value="Add" class="ui-button" onclick="paySubscription();" /></tr>
        </table>
      </form>
      <div id="paymentStatus" style="display:none;" class="lds-ripple"></div>
    {% else %}
      <div id="accountExpiration">Login first to access your settings.</div>
    {% endif %}
    </div>
  </div>
  <div id="rightMainContent" class="ghCol">
    <div id="accountReports" class="ghWidgetBox ui-widget-content">
      <div class="reportPage" id="connectPage">
        <h2 style="text-align: center;cursor: pointer;" onclick="connect();">Connect your wallet to get started.</h2>
      </div>
      <div class="reportPage" id="loginPage">
        <h2 style="text-align: center;cursor: pointer;" onclick="login(true);">Login to activate your subscription.</h2>
      </div>
      <div class="reportPage" id="subscribePage">
        <h2 style="text-align: center;">Subscribe Now</h2>
      </div>
      <div class="sectionHead"></div>
      <h3 id="benefitsHeader">Connect and subscribe to enjoy these benefits:</h3>
      <div id="benefitsPage">
        <ul class="checkList">
          <li>Run reports for multiple wallets combined</li>
          <li>View and launch past reports</li>
          <li>Cached transactions and saved reports not removed after 60 days</li>
          <li>Manage multiple pre-defined wallet groups for reports</li>
        </ul>
      </div>
      <div class="reportPage" id="groupPage">
        <div class="tableTop">My Wallet Groups<input id="addGroupButton" type="button" value="New Group" onclick="addGroup();" class="lButton" style="float:right;"/></div>
        <table id="groupList" class="statusList"></table>
      </div>
      <div class="sectionHead"></div>
      <div class="reportPage" id="reportPage">
        <div class="tableTop">My Tax Reports</div>
        <table id="reportList" class="statusList"></table>
      </div>
    </div>
  </div>
</div>
<div class="footer">
	<a href="{{ BASE_SCRIPT_URL }}home.py" title="Report page">Home</a> | <a href="{{ BASE_SCRIPT_URL }}help.py" title="Get help" target="_blank">Help</a> | <a href="https://github.com/pwillworth/dfkreport" title="Open Source Code for the application" target="_blank">Source</a> | <a href="https://github.com/pwillworth/dfkreport/discussions" title="Ask questions or submit ideas" target="_blank">Contact</a> | <a href="{{ BASE_SCRIPT_URL }}about.py" title="Support us and get info" target="_blank">About</a>
	<p style="padding: 4px;font-weight:normal;font-size: .7em;">This utility is intended to help quantify potential taxable events for account activity within the <a href="https://defikingdoms.com">DeFi Kingdoms</a> game.  It makes no claims at being a full accounting of your tax liablity.</p>
</div>
<div id="groupDialog" class="window">
  <h2 style="display: inline;">New Wallet Group</h2><div style="float: right;position: relative;top:0px;"><a href="#" class="close" onclick="hideWindow('groupDialog')">Close</a></div>
  <div class="searchInput"><label for="groupName">Group Name:</label><br /><input type="text" id="groupName" size="44" maxlength="60" value="" /></div>
  <div class="searchInput"><label for="walletList">Wallets:</label><br /><textarea id="walletList" name="walletList" rows="4" cols="42" maxlength="2000"></textarea></div>
  
  <div id="busyImgAdd" style="display:none;float:right;"><div class="lds-ripple"><div></div><div></div></div></div>
  <span id="addInfo"></span>
  <div style="float:right;margin:6px;padding-top:40px;"><input type="button" class="lButton" value="Create" id="createGroup" onclick="createGroup(document.getElementById('groupName').value, document.getElementById('walletList').value);" /></div>
</div>
<div id="mask" onclick="hideWindow('groupDialog')"></div>
</body>
</html>